<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë°•ì§€ì€ ë‚´ì§‘ë§ˆë ¨ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); /* shadow-2xl */
        }
        .card-header { padding: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .card-body { padding: 1.5rem; flex-grow: 1; }
        .card-footer { background-color: #f8fafc; padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
        .info-icon { cursor: pointer; position: relative; display: inline-flex; align-items: center; justify-content: center; width: 1rem; height: 1rem; background-color: #94a3b8; color: white; border-radius: 50%; font-size: 0.75rem; font-weight: bold; margin-left: 0.25rem; }
        .tooltip { visibility: hidden; width: 260px; background-color: #1e293b; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -130px; opacity: 0; transition: opacity 0.3s, visibility 0.3s; }
        .info-icon:hover .tooltip, .tooltip.visible { visibility: visible; opacity: 1; }
        details > summary { cursor: pointer; }
        
        /* --- FIX for Safari/Chrome number input --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">ë°•ì§€ì€ ë‚´ì§‘ë§ˆë ¨ ê³„ì‚°ê¸° ğŸ•</h1>
            <p class="mt-3 text-slate-600">í˜„ ìì‚° ìƒí™©ê³¼ ë¯¸ë˜ ì „ë§ì„ ë°”íƒ•ìœ¼ë¡œ<br>6ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¹„êµí•´ì¤ë‹ˆë‹¤</p>
        </header>

        <!-- Input Sections -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-10 max-w-4xl mx-auto ring-1 ring-slate-200">
            <h2 class="text-2xl font-semibold mb-6 text-center text-slate-800">í˜„ì¬ ë‚´ ìƒíƒœëŠ”...</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="initialInvestment" class="block text-sm font-medium text-slate-700 mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ (ìê¸° ìë³¸)</label>
                    <div class="relative"><input type="number" id="initialInvestment" class="w-full p-3 border border-slate-300 rounded-lg" value="5500"><span class="absolute inset-y-0 right-0 pr-4 flex items-center text-sm text-slate-500">ë§Œì›</span></div>
                </div>
                <div>
                    <label for="annualIncome" class="block text-sm font-medium text-slate-700 mb-1">ë‚˜ì˜ ì—°ë´‰</label>
                    <div class="relative"><input type="number" id="annualIncome" class="w-full p-3 border border-slate-300 rounded-lg" value="4500"><span class="absolute inset-y-0 right-0 pr-4 flex items-center text-sm text-slate-500">ë§Œì›</span></div>
                </div>
            </div>

            <details class="border-t pt-6">
                <summary class="font-semibold text-lg text-slate-700 hover:text-indigo-600">ì‹œë®¬ë ˆì´ì…˜ ë³€ìˆ˜ ì„¤ì • (ê³ ê¸‰)</summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mt-4">
                    <!-- House Prices -->
                    <div><label for="jeonseDeposit" class="text-sm font-medium">ì „ì„¸ ë³´ì¦ê¸ˆ</label><div class="relative"><input type="number" id="jeonseDeposit" class="w-full p-2 border border-slate-200 rounded-md" value="21000"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë§Œì›</span></div></div>
                    <div><label for="housePriceVilla" class="text-sm font-medium">ë¹Œë¼/ì˜¤í”¼ìŠ¤í…” ê°€ê²©</label><div class="relative"><input type="number" id="housePriceVilla" class="w-full p-2 border border-slate-200 rounded-md" value="26000"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë§Œì›</span></div></div>
                    <div><label for="housePriceApt" class="text-sm font-medium">ì•„íŒŒíŠ¸ ê°€ê²©</label><div class="relative"><input type="number" id="housePriceApt" class="w-full p-2 border border-slate-200 rounded-md" value="50000"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë§Œì›</span></div></div>
                    <!-- Loan Term -->
                    <div><label for="loanTerm" class="text-sm font-medium">ëŒ€ì¶œ ë§Œê¸°</label><div class="relative"><input type="number" id="loanTerm" class="w-full p-2 border border-slate-200 rounded-md" value="30"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë…„</span></div></div>
                    <!-- Interest Rates -->
                    <div><label for="rateBank" class="text-sm font-medium">ì‹œì¤‘ì€í–‰ ê¸ˆë¦¬</label><div class="relative"><input type="number" id="rateBank" class="w-full p-2 border border-slate-200 rounded-md" value="4.1" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="rateDidimdolSingle" class="text-sm font-medium">ë””ë”¤ëŒ(ë‹¨ë…) ê¸ˆë¦¬</label><div class="relative"><input type="number" id="rateDidimdolSingle" class="w-full p-2 border border-slate-200 rounded-md" value="3.8" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="rateDidimdolMarried" class="text-sm font-medium">ë””ë”¤ëŒ(ì‹ í˜¼) ê¸ˆë¦¬</label><div class="relative"><input type="number" id="rateDidimdolMarried" class="w-full p-2 border border-slate-200 rounded-md" value="3.1" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="rateRent" class="text-sm font-medium">ì „ì„¸ìê¸ˆëŒ€ì¶œ ê¸ˆë¦¬</label><div class="relative"><input type="number" id="rateRent" class="w-full p-2 border border-slate-200 rounded-md" value="2.8" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="rateMinus" class="text-sm font-medium">ë§ˆì´ë„ˆìŠ¤í†µì¥ ê¸ˆë¦¬</label><div class="relative"><input type="number" id="rateMinus" class="w-full p-2 border border-slate-200 rounded-md" value="5.2" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <!-- Appreciation & Investment Rates -->
                    <div><label for="appreciationVilla" class="text-sm font-medium">ë¹Œë¼/ì˜¤í”¼ìŠ¤í…” ì—° ìƒìŠ¹ë¥ </label><div class="relative"><input type="number" id="appreciationVilla" class="w-full p-2 border border-slate-200 rounded-md" value="1.5" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="appreciationApt" class="text-sm font-medium">ì•„íŒŒíŠ¸ ì—° ìƒìŠ¹ë¥ </label><div class="relative"><input type="number" id="appreciationApt" class="w-full p-2 border border-slate-200 rounded-md" value="5.0" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <div><label for="investmentReturn" class="text-sm font-medium">ì „ì„¸ ì‹œ íˆ¬ììˆ˜ìµë¥ </label><div class="relative"><input type="number" id="investmentReturn" class="w-full p-2 border border-slate-200 rounded-md" value="4.0" step="0.1"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">%</span></div></div>
                    <!-- Spouse Income -->
                    <div><label for="spouseInvestment" class="text-sm font-medium">ë°°ìš°ì ì´ˆê¸° ìë³¸ (ì‹ í˜¼ë¶€ë¶€ìš©)</label><div class="relative"><input type="number" id="spouseInvestment" class="w-full p-2 border border-slate-200 rounded-md" value="5000"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë§Œì›</span></div></div>
                    <div><label for="spouseIncome" class="text-sm font-medium">ë°°ìš°ì ì—°ë´‰ (ì‹ í˜¼ë¶€ë¶€ìš©)</label><div class="relative"><input type="number" id="spouseIncome" class="w-full p-2 border border-slate-200 rounded-md" value="4000"><span class="absolute inset-y-0 right-0 pr-3 flex items-center text-xs text-slate-500">ë§Œì›</span></div></div>
                </div>
            </details>
        </div>

        <!-- Scenarios Output Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" id="outputContainer">
            <!-- Dynamically generated cards will be inserted here -->
        </div>

        <footer class="text-center mt-12 text-xs text-slate-500">
            <p>(C) Seyong Oh, ë³¸ ê³„ì‚°ê¸°ëŠ” ì…ë ¥ëœ ë³€ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì°¸ê³ ìš© ìë£Œì„</p>
        </footer>
    </div>

    <script>
    // --- Scenario Data ---
    const scenarios = [
        { id: 'rent', title: 'ì‹œë‚˜ë¦¬ì˜¤ 1: ìƒˆ ì „ì„¸ì§‘ êµ¬í•˜ê¸°', color: 'green', type: 'rent' },
        { id: 'buyNow', title: 'ì‹œë‚˜ë¦¬ì˜¤ 2: ë¹Œë¼/ì˜¤í”¼ìŠ¤í…” ì¦‰ì‹œ ë§¤ìˆ˜', color: 'red', type: 'buy', loan: 'bank', appreciation: 'villa' },
        { id: 'villa', title: 'ì‹œë‚˜ë¦¬ì˜¤ 3: ë¹Œë¼ ë§¤ìˆ˜ (30ì„¸, ë””ë”¤ëŒ)', color: 'sky', type: 'buy', loan: 'didimdol_single', appreciation: 'villa' },
        { id: 'officetel', title: 'ì‹œë‚˜ë¦¬ì˜¤ 4: ì˜¤í”¼ìŠ¤í…” ë§¤ìˆ˜ (30ì„¸, ë””ë”¤ëŒ)', color: 'orange', type: 'buy', loan: 'didimdol_single', appreciation: 'officetel' },
        { id: 'apt_single', title: 'ì‹œë‚˜ë¦¬ì˜¤ 5: ì•„íŒŒíŠ¸ ë§¤ìˆ˜ (í˜¼ì)', color: 'indigo', type: 'buy_apt_single' },
        { id: 'apt_married', title: 'ì‹œë‚˜ë¦¬ì˜¤ 6: ì•„íŒŒíŠ¸ ë§¤ìˆ˜ (ì‹ í˜¼)', color: 'purple', type: 'buy_apt_married' }
    ];
    const prosCons = {
        rent: { pros: 'ê±°ì£¼ì§€ ì´ì „ ìœ ì—°ì„±, ì£¼íƒ ì†Œìœ ì— ë”°ë¥¸ ì„¸ê¸ˆ/ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ ì—†ìŒ.', cons: 'ìì‚° ê°€ì¹˜ ìƒìŠ¹ ê¸°íšŒ ìƒì‹¤, ì „ì„¸ê¸ˆ ìƒìŠ¹ ë° ë³´ì¦ê¸ˆ ë°˜í™˜ ë¦¬ìŠ¤í¬ ì¡´ì¬.' },
        buyNow: { pros: 'ì¦‰ì‹œ ë‚´ ì§‘ ë§ˆë ¨ìœ¼ë¡œ ì£¼ê±° ì•ˆì •ì„± í™•ë³´.', cons: 'ë§Œ 30ì„¸ ë¯¸ë§Œìœ¼ë¡œ ë””ë”¤ëŒ ë¶ˆê°€, ë†’ì€ ì‹œì¤‘ì€í–‰ ê¸ˆë¦¬ë¡œ ì´ì ë¶€ë‹´ ê·¹ëŒ€í™”.' },
        villa: { pros: 'ì €ê¸ˆë¦¬ ë””ë”¤ëŒ ëŒ€ì¶œ í™œìš© ê°€ëŠ¥, ì•ˆì •ì ì¸ ë‚´ ì§‘ ë§ˆë ¨, ì›”ì„¸ ëŒ€ì‹  ìì‚° ì¶•ì .', cons: 'ì•„íŒŒíŠ¸ ëŒ€ë¹„ ë‚®ì€ í™˜ê¸ˆì„± ë° ê°€ì¹˜ ìƒìŠ¹ë¥ , ìƒì• ìµœì´ˆ í˜œíƒ ì†Œì§„.' },
        officetel: { pros: 'í¸ë¦¬í•œ ê´€ë¦¬, ìš°ìˆ˜í•œ ë³´ì•ˆ ë° í¸ì˜ì‹œì„¤, ì—­ì„¸ê¶Œ ì…ì§€ ì‹œ ìƒëŒ€ì  í™˜ê¸ˆì„±.', cons: 'ë†’ì€ ê´€ë¦¬ë¹„, ë‚®ì€ ëŒ€ì§€ ì§€ë¶„ìœ¼ë¡œ ìì‚°ê°€ì¹˜ ìƒìŠ¹ ì œí•œì , 1ê°€êµ¬ 2ì£¼íƒ ë¦¬ìŠ¤í¬.' },
        apt_single: { pros: 'ê°€ì¥ ë†’ì€ ìì‚° ê°€ì¹˜ ìƒìŠ¹ ê¸°ëŒ€, ì•ˆì •ì ì¸ ìš°ëŸ‰ ìì‚° í™•ë³´.', cons: 'ë†’ì€ ìê¸°ìë³¸ í•„ìš”, ì‹œì¤‘ì€í–‰ ëŒ€ì¶œ í˜¼í•©ìœ¼ë¡œ ì›” ìƒí™˜ ë¶€ë‹´ ë§¤ìš° í¼.' },
        apt_married: { pros: 'ê°•ë ¥í•œ ì‹ í˜¼ë¶€ë¶€ í˜œíƒ(ë†’ì€ í•œë„, ë‚®ì€ ê¸ˆë¦¬)ìœ¼ë¡œ ìš°ëŸ‰ìì‚° ë§¤ìˆ˜ ê°€ëŠ¥.', cons: 'ê²°í˜¼ì´ë¼ëŠ” í†µì œ ë¶ˆê°€ëŠ¥í•œ ë³€ìˆ˜ì— ì˜ì¡´, ì‹œì¥ íƒ€ì´ë° ë¦¬ìŠ¤í¬.' }
    };

    // --- DOM Elements ---
    const inputs = {
        initialInvestment: document.getElementById('initialInvestment'),
        annualIncome: document.getElementById('annualIncome'),
        spouseInvestment: document.getElementById('spouseInvestment'),
        spouseIncome: document.getElementById('spouseIncome'),
        jeonseDeposit: document.getElementById('jeonseDeposit'),
        housePriceVilla: document.getElementById('housePriceVilla'),
        housePriceApt: document.getElementById('housePriceApt'),
        loanTerm: document.getElementById('loanTerm'),
        investmentReturn: document.getElementById('investmentReturn'),
        rateBank: document.getElementById('rateBank'),
        rateDidimdolSingle: document.getElementById('rateDidimdolSingle'),
        rateDidimdolMarried: document.getElementById('rateDidimdolMarried'),
        rateRent: document.getElementById('rateRent'),
        rateMinus: document.getElementById('rateMinus'),
        appreciationVilla: document.getElementById('appreciationVilla'),
        appreciationApt: document.getElementById('appreciationApt')
    };
    const outputContainer = document.getElementById('outputContainer');

    // --- Helper Functions ---
    const toEok = (num) => {
        if (isNaN(num) || !isFinite(num)) return 'ê³„ì‚° ë¶ˆê°€';
        if (num >= 100000000) {
            return `${(num / 100000000).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1')}ì–µ`;
        }
        return `${Math.round(num / 10000).toLocaleString()}ë§Œì›`;
    };
    const toWonMonthly = (num) => isNaN(num) || !isFinite(num) ? 'ê³„ì‚° ë¶ˆê°€' : `${Math.round(num).toLocaleString()} ì›`;
    const parseVal = (el) => parseFloat(el.value) || 0;
    const parseRate = (el) => (parseFloat(el.value) || 0) / 100;

    function calculatePMT(rate, nper, pv) {
        if (pv <= 0 || rate <= 0 || nper <= 0) return 0;
        const monthlyRate = rate / 12;
        return (pv * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -nper));
    }

    function calculateRemainingBalance(rate, nper, pmt, pv) {
        if (pv <= 0) return 0;
        const monthlyRate = rate / 12;
        return pv * Math.pow(1 + monthlyRate, nper) - pmt * (Math.pow(1 + monthlyRate, nper) - 1) / monthlyRate;
    }
    
    function getTakeHomePay(annualIncome) {
        // More accurate estimation
        if (annualIncome <= 50000000) return (annualIncome * 0.86) / 12;
        if (annualIncome <= 80000000) return (annualIncome * 0.84) / 12;
        return (annualIncome * 0.82) / 12;
    }

    // --- Main Calculation Logic ---
    function calculateAndRender() {
        const MINUS_LOAN_LIMIT = 50000000;
        const initialInvestment = parseVal(inputs.initialInvestment) * 10000;
        const spouseInvestment = parseVal(inputs.spouseInvestment) * 10000;
        const annualIncome = parseVal(inputs.annualIncome) * 10000;
        const spouseIncome = parseVal(inputs.spouseIncome) * 10000;
        const takeHomePay = getTakeHomePay(annualIncome);
        const termYears = parseVal(inputs.loanTerm);
        const termMonths = termYears * 12;

        const vars = {
            jeonseDeposit: parseVal(inputs.jeonseDeposit) * 10000,
            housePriceVilla: parseVal(inputs.housePriceVilla) * 10000,
            housePriceApt: parseVal(inputs.housePriceApt) * 10000,
            rateBank: parseRate(inputs.rateBank),
            rateDidimdolSingle: parseRate(inputs.rateDidimdolSingle),
            rateDidimdolMarried: parseRate(inputs.rateDidimdolMarried),
            rateRent: parseRate(inputs.rateRent),
            rateMinus: parseRate(inputs.rateMinus),
            appreciationVilla: parseRate(inputs.appreciationVilla),
            appreciationOfficetel: parseRate(inputs.appreciationVilla) * 0.5,
            appreciationApt: parseRate(inputs.appreciationApt),
            investmentReturn: parseRate(inputs.investmentReturn)
        };

        outputContainer.innerHTML = '';
        const scenarioData = {};

        scenarios.forEach(s => {
            let monthlyPayment = 0;
            let monthlySavings = 0;
            let subtitleText = '';
            let netAsset5Tooltip = '';
            let netAsset10Tooltip = '';
            let results = {};
            let footerAddon = '';
            let paymentBlockHTML = '';

            if (s.type === 'rent') {
                const rentDeposit = vars.jeonseDeposit;
                subtitleText = `ì „ì„¸ê¸ˆ ${toEok(rentDeposit)} ê¸°ì¤€`;
                
                if (initialInvestment < rentDeposit * 0.2) {
                    const errorCardHTML = `<div class="card border-t-4 border-gray-400 opacity-70"><div class="card-header"><h3 class="text-xl font-bold text-slate-800">${s.title}</h3><p class="text-sm text-slate-500 mt-1">${subtitleText}</p></div><div class="card-body flex flex-col items-center justify-center text-center"><p class="text-lg font-semibold text-gray-600">ì´ˆê¸° íˆ¬ìê¸ˆ ë¶€ì¡±</p><p class="text-sm text-gray-500 mt-2">ì „ì„¸ë³´ì¦ê¸ˆì˜ 20%ì¸<br>${toEok(rentDeposit * 0.2)}ì´ í•„ìš”í•©ë‹ˆë‹¤.</p></div><div class="card-footer text-xs space-y-2"><p><strong class="text-green-600">ì´ì :</strong> ${prosCons[s.id].pros}</p><p><strong class="text-red-600">ì£¼ì˜ì‚¬í•­:</strong> ${prosCons[s.id].cons}</p></div></div>`;
                    outputContainer.innerHTML += errorCardHTML;
                    return;
                }

                const rentLoan = Math.max(0, rentDeposit - initialInvestment);
                const loanDetailsText = `ì „ì„¸ëŒ€ì¶œ ${toEok(rentLoan)}`;
                monthlyPayment = rentLoan * vars.rateRent / 12;
                monthlySavings = takeHomePay - monthlyPayment;
                const appliedRateText = `${(vars.rateRent * 100).toFixed(1)}%`;
                
                const savingsPerMonth = monthlySavings > 0 ? monthlySavings - 1500000 : 0;
                
                const calcNetAsset = (years) => {
                    if (savingsPerMonth <= 0) return initialInvestment;
                    let fv_of_savings = savingsPerMonth * 12 * ((Math.pow(1 + vars.investmentReturn, years) - 1) / vars.investmentReturn);
                    return fv_of_savings + initialInvestment;
                };
                results = { netAsset5: calcNetAsset(5), netAsset10: calcNetAsset(10) };
                netAsset5Tooltip = `ì´ˆê¸° íˆ¬ìê¸ˆ(${toEok(initialInvestment)}) + ì›” ${toWonMonthly(savingsPerMonth)}ì”© ì €ì¶•ì•¡ì„ ì—° ${(vars.investmentReturn * 100).toFixed(1)}% ìˆ˜ìµë¥ ë¡œ ë³µë¦¬ ê³„ì‚°í•œ ê²°ê³¼ì„.`;
                netAsset10Tooltip = netAsset5Tooltip;
                paymentBlockHTML = `<p class="text-2xl md:text-3xl font-bold text-${s.color}-600">${toWonMonthly(monthlyPayment)}</p>
                                    <p class="text-xs text-slate-500 mt-1">ëŒ€ì¶œêµ¬ì„±: ${loanDetailsText}</p>
                                    <p class="text-xs text-slate-500 mt-1">ì ìš©ê¸ˆë¦¬: ${appliedRateText}</p>`;

            } else if (s.type.startsWith('buy')) {
                const generateTooltip = (years, p, apr, lr, pmt, mla, mla_principal, benefitText) => {
                    const fv = p * Math.pow(1 + apr, years);
                    const rem = calculateRemainingBalance(lr, years * 12, pmt, mla);
                    return `${years}ë…„ í›„ ì˜ˆìƒ ì§‘ê°’ (${toEok(fv)}) - ëŒ€ì¶œì”ì•¡ (${toEok(rem + mla_principal)}) ì„. ${benefitText}`;
                };
                
                const generateMixedTooltip = (years, p, apr, lr1, pmt1, la1, lr2, pmt2, la2, mla_principal, benefitText) => {
                    const fv = p * Math.pow(1 + apr, years);
                    const rem1 = calculateRemainingBalance(lr1, years * 12, pmt1, la1);
                    const rem2 = calculateRemainingBalance(lr2, years * 12, pmt2, la2);
                    return `${years}ë…„ í›„ ì˜ˆìƒ ì§‘ê°’ (${toEok(fv)}) - ì´ ëŒ€ì¶œì”ì•¡ (${toEok(rem1 + rem2 + mla_principal)}) ì„. ${benefitText}`;
                };
                
                let price, appreciationRate, loanRate, mortgageLoanAmount, minusLoanAmount = 0, loanDetailsText = '', appliedRateText = '';
                let benefitText = '';
                let currentInvestment = (s.id === 'apt_married') ? initialInvestment + spouseInvestment : initialInvestment;

                if (s.type === 'buy_apt_single' || s.type === 'buy_apt_married') {
                    price = vars.housePriceApt;
                    subtitleText = `ì•„íŒŒíŠ¸ ${toEok(price)} ë§¤ë§¤ ê¸°ì¤€`;
                    appreciationRate = vars.appreciationApt;
                } else {
                    price = vars.housePriceVilla;
                    subtitleText = `ë¹Œë¼/ì˜¤í”¼ìŠ¤í…” ${toEok(price)} ë§¤ë§¤ ê¸°ì¤€`;
                    appreciationRate = (s.id === 'officetel') ? vars.appreciationOfficetel : vars.appreciationVilla;
                }

                const ltv = 0.8; // All scenarios are now first-time buyer
                let didimdolLimit = Infinity;
                if (s.type === 'buy_apt_married') didimdolLimit = 400000000;
                else if (s.type === 'buy_apt_single') didimdolLimit = 300000000;
                else if (s.loan === 'didimdol_single') didimdolLimit = 300000000;
                
                const maxLoanByLTV = price * ltv;
                const maxPossibleLoan = Math.min(maxLoanByLTV, (s.type === 'buy_apt_single') ? maxLoanByLTV : didimdolLimit);
                const minRequiredCapital = price - maxPossibleLoan;

                if (currentInvestment < minRequiredCapital) {
                    const shortfall = minRequiredCapital - currentInvestment;
                    if (shortfall > MINUS_LOAN_LIMIT) {
                        const errorCardHTML = `<div class="card border-t-4 border-gray-400 opacity-70"><div class="card-header"><h3 class="text-xl font-bold text-slate-800">${s.title}</h3><p class="text-sm text-slate-500 mt-1">${subtitleText}</p></div><div class="card-body flex flex-col items-center justify-center text-center"><p class="text-lg font-semibold text-gray-600">ì´ˆê¸° íˆ¬ìê¸ˆ ë¶€ì¡±</p><p class="text-sm text-gray-500 mt-2">ì´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìœ„í•´ì„œëŠ”<br>ìµœì†Œ ${toEok(minRequiredCapital - MINUS_LOAN_LIMIT)}ì˜<br>ì¶”ê°€ ìë³¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p></div><div class="card-footer text-xs space-y-2"><p><strong class="text-green-600">ì´ì :</strong> ${prosCons[s.id].pros}</p><p><strong class="text-red-600">ì£¼ì˜ì‚¬í•­:</strong> ${prosCons[s.id].cons}</p></div></div>`;
                        outputContainer.innerHTML += errorCardHTML;
                        return;
                    }
                    minusLoanAmount = shortfall;
                    mortgageLoanAmount = maxPossibleLoan;
                } else {
                    mortgageLoanAmount = price - currentInvestment;
                }

                const minusLoanInterestPayment = minusLoanAmount * vars.rateMinus / 12;

                if (s.type === 'buy_apt_single') {
                    const didimdolLoan = Math.min(mortgageLoanAmount, didimdolLimit);
                    const bankLoan = mortgageLoanAmount - didimdolLoan;
                    loanDetailsText = `ë””ë”¤ëŒ ${toEok(didimdolLoan)} + ì€í–‰ ${toEok(bankLoan)}`;
                    if (minusLoanAmount > 0) loanDetailsText += ` + ì‹ ìš© ${toEok(minusLoanAmount)}`;
                    
                    const didimdolPayment = calculatePMT(vars.rateDidimdolSingle, termMonths, didimdolLoan);
                    const bankPayment = calculatePMT(vars.rateBank, termMonths, bankLoan);
                    monthlyPayment = didimdolPayment + bankPayment + minusLoanInterestPayment;
                    
                    appliedRateText = `ë””ë”¤ëŒ(ë‹¨ë…) ${(vars.rateDidimdolSingle * 100).toFixed(1)}% + ì€í–‰ ${(vars.rateBank * 100).toFixed(1)}%`;
                    if(minusLoanAmount > 0) appliedRateText += ` + ì‹ ìš© ${(vars.rateMinus * 100).toFixed(1)}%`;
                    
                    monthlySavings = takeHomePay - monthlyPayment;
                    
                    const calcNetAsset = (years) => price * Math.pow(1 + appreciationRate, years) - calculateRemainingBalance(vars.rateDidimdolSingle, years*12, didimdolPayment, didimdolLoan) - calculateRemainingBalance(vars.rateBank, years*12, bankPayment, bankLoan) - minusLoanAmount;
                    results = { netAsset5: calcNetAsset(5), netAsset10: calcNetAsset(10) };
                    benefitText = `ìƒì• ìµœì´ˆ í˜œíƒ(LTV 80%, í•œë„ 3ì–µ)ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    netAsset5Tooltip = generateMixedTooltip(5, price, appreciationRate, vars.rateDidimdolSingle, didimdolPayment, didimdolLoan, vars.rateBank, bankPayment, bankLoan, minusLoanAmount, benefitText);
                    netAsset10Tooltip = generateMixedTooltip(10, price, appreciationRate, vars.rateDidimdolSingle, didimdolPayment, didimdolLoan, vars.rateBank, bankPayment, bankLoan, minusLoanAmount, benefitText);

                } else {
                    if (s.type === 'buy_apt_married') {
                        loanRate = vars.rateDidimdolMarried;
                        benefitText = `ìƒì• ìµœì´ˆ ì‹ í˜¼ë¶€ë¶€ í˜œíƒ(LTV 80%, í•œë„ 4ì–µ)ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        appliedRateText = `ë””ë”¤ëŒ(ì‹ í˜¼) ${(loanRate * 100).toFixed(1)}%`;
                        loanDetailsText = `ë¶€ë¶€ìë³¸ ${toEok(currentInvestment)} + ë””ë”¤ëŒ(ì‹ í˜¼) ${toEok(mortgageLoanAmount)}`;
                    } else {
                        loanRate = (s.loan === 'didimdol_single') ? vars.rateDidimdolSingle : vars.rateBank;
                        benefitText = `ìƒì• ìµœì´ˆ í˜œíƒ(LTV 80%)ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        appliedRateText = `${(loanRate * 100).toFixed(1)}%`;
                        loanDetailsText = `ì£¼ë‹´ëŒ€ ${toEok(mortgageLoanAmount)}`;
                    }
                    
                    if (minusLoanAmount > 0) loanDetailsText += ` + ì‹ ìš© ${toEok(minusLoanAmount)}`;
                    if (minusLoanAmount > 0) appliedRateText += ` + ì‹ ìš© ${(vars.rateMinus * 100).toFixed(1)}%`;

                    const mortgagePayment = calculatePMT(loanRate, termMonths, mortgageLoanAmount);
                    monthlyPayment = mortgagePayment + minusLoanInterestPayment;
                    
                    if (s.type === 'buy_apt_married') {
                        const combinedTakeHomePay = getTakeHomePay(annualIncome + spouseIncome);
                        monthlySavings = combinedTakeHomePay - monthlyPayment;
                    } else {
                        monthlySavings = takeHomePay - monthlyPayment;
                    }

                    const calcNetAsset = (years) => price * Math.pow(1 + appreciationRate, years) - calculateRemainingBalance(loanRate, years * 12, mortgagePayment, mortgageLoanAmount) - minusLoanAmount;
                    results = { netAsset5: calcNetAsset(5), netAsset10: calcNetAsset(10) };
                    netAsset5Tooltip = generateTooltip(5, price, appreciationRate, loanRate, mortgagePayment, mortgageLoanAmount, minusLoanAmount, benefitText);
                    netAsset10Tooltip = generateTooltip(10, price, appreciationRate, loanRate, mortgagePayment, mortgageLoanAmount, minusLoanAmount, benefitText);
                    if (s.id === 'officetel') {
                        const officetelNote = ' (â€» ì˜¤í”¼ìŠ¤í…” ìƒìŠ¹ë¥ ì€ ë¹Œë¼ì˜ 50%ë¡œ ê°€ì •)';
                        netAsset5Tooltip += officetelNote;
                        netAsset10Tooltip += officetelNote;
                    }
                }
                
                paymentBlockHTML = `<p class="text-2xl md:text-3xl font-bold text-${s.color}-600">${toWonMonthly(monthlyPayment)}</p>
                                    <p class="text-xs text-slate-500 mt-1">ëŒ€ì¶œêµ¬ì„±: ${loanDetailsText}</p>
                                    <p class="text-xs text-slate-500 mt-1">ì ìš©ê¸ˆë¦¬: ${appliedRateText}</p>`;
            }
            
            const currentTakeHomePay = (s.id === 'apt_married') ? getTakeHomePay(annualIncome + spouseIncome) : takeHomePay;
            const monthlySavingsTooltip = `ì‹¤ìˆ˜ë ¹ì•¡(${toWonMonthly(currentTakeHomePay)}) - ì£¼ê±°ë¹„ìš©(${toWonMonthly(monthlyPayment)})`;

            scenarioData[s.id] = { monthlyPayment, ...results, totalPayment10yr: monthlyPayment * 120 };
            
            if (s.id === 'apt_married' && scenarioData['apt_single']) {
                const interestSavings = scenarioData['apt_single'].totalPayment10yr - scenarioData['apt_married'].totalPayment10yr;
                const netAssetDifference = scenarioData['apt_married'].netAsset10 - scenarioData['apt_single'].netAsset10;
                const totalAdvantage = interestSavings + netAssetDifference;
                
                if (totalAdvantage > 0) {
                    const savingsTooltip = `ë‹¨ë… ë§¤ìˆ˜ ëŒ€ë¹„ 10ë…„ê°„ ì ˆì•½í•œ ì´ ì´ì(${toEok(interestSavings)})ì™€ ëŠ˜ì–´ë‚œ ìˆœìì‚°(${toEok(netAssetDifference)})ì„ í•©ì‚°í•œ ì´ ì¬ë¬´ì  ì´ë“ì…ë‹ˆë‹¤.`;
                    footerAddon = `<p><strong class="text-blue-600">ë‹¨ë… ë§¤ìˆ˜ ëŒ€ë¹„ 10ë…„ ì´ ì´ë“:</strong> ${toEok(totalAdvantage)} <span class="info-icon">i<span class="tooltip">${savingsTooltip}</span></span></p>`;
                }
            }

            // Render card
            const cardHTML = `
                <div class="card border-t-4 border-${s.color}-500">
                    <div class="card-header">
                        <h3 class="text-xl font-bold text-slate-800">${s.title}</h3>
                        <p class="text-sm text-slate-500 mt-1">${subtitleText}</p>
                    </div>
                    <div class="card-body space-y-5">
                        <div>
                            <p class="text-sm font-medium text-slate-500 flex items-center">${s.type === 'rent' ? 'ì›” ì£¼ê±° ë¹„ìš© (ì´ì)' : 'ì›” ìƒí™˜ì•¡ (ì›ë¦¬ê¸ˆ)'}</p>
                            ${paymentBlockHTML}
                        </div>
                        <div>
                            <p class="text-sm font-medium text-slate-500 flex items-center">ì£¼ê±°ë¹„ìš© ì°¨ê° í›„ ì›”ê¸‰<span class="info-icon">i<span class="tooltip">${monthlySavingsTooltip}</span></span></p>
                            <p class="text-2xl md:text-3xl font-bold text-${s.color}-600">${toWonMonthly(monthlySavings)}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div>
                                <p class="text-sm font-medium text-slate-500 flex items-center">5ë…„ í›„ ìˆœìì‚°<span class="info-icon">i<span class="tooltip">${netAsset5Tooltip}</span></span></p>
                                <p class="text-xl font-semibold text-slate-700">${toEok(results.netAsset5)}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-500 flex items-center">10ë…„ í›„ ìˆœìì‚°<span class="info-icon">i<span class="tooltip">${netAsset10Tooltip}</span></span></p>
                                <p class="text-xl font-semibold text-slate-700">${toEok(results.netAsset10)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-xs space-y-2">
                        <p><strong class="text-green-600">ì´ì :</strong> ${prosCons[s.id].pros}</p>
                        <p><strong class="text-red-600">ì£¼ì˜ì‚¬í•­:</strong> ${prosCons[s.id].cons}</p>
                        ${footerAddon}
                    </div>
                </div>
            `;
            outputContainer.innerHTML += cardHTML;
        });
    }

    // --- Event Listeners ---
    Object.values(inputs).forEach(el => el.addEventListener('input', calculateAndRender));
    window.addEventListener('load', () => {
        calculateAndRender();
        // Add touch event for mobile tooltips
        document.body.addEventListener('click', function(e) {
            const target = e.target;
            if (target.classList.contains('info-icon')) {
                const tooltip = target.querySelector('.tooltip');
                if (tooltip) {
                    tooltip.classList.toggle('visible');
                }
            } else {
                document.querySelectorAll('.tooltip.visible').forEach(tooltip => {
                    tooltip.classList.remove('visible');
                });
            }
        });
    });
    </script>
</body>
</html>
